<div class="lead-scoring-container">
  <!-- Full screen loading overlay -->
  <app-loading-overlay
    [show]="showLoadingOverlay"
    [title]="loadingTitle"
    [message]="loadingMessage"
    [showProgress]="showProgress"
    [progress]="progress"
  ></app-loading-overlay>

  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>AI LEAD SCORING</h1>
    </div>
    <button class="btn-primary" (click)="analyzeAll()" [disabled]="analyzing">
      <span *ngIf="!analyzing">Analisa semuanya</span>
      <span *ngIf="analyzing">Menganalisa...</span>
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card clickable" (click)="applyFilter('ALL')">
      <div class="stat-info">
        <span class="stat-label">Total Leads</span>
        <span class="stat-value">{{ statistics.totalLeads }}</span>
      </div>
    </div>

    <div class="stat-card clickable" (click)="applyFilter('HOT')">
      <div class="stat-info">
        <span class="stat-label">Hot Leads</span>
        <span class="stat-value">{{ statistics.hotLeads }}</span>
      </div>
    </div>

    <div class="stat-card clickable" (click)="applyFilter('WARM')">
      <div class="stat-info">
        <span class="stat-label">Warm Leads</span>
        <span class="stat-value">{{ statistics.warmLeads }}</span>
      </div>
    </div>

    <div class="stat-card clickable" (click)="applyFilter('COLD')">
      <div class="stat-info">
        <span class="stat-label">Cold Leads</span>
        <span class="stat-value">{{ statistics.coldLeads }}</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-section">
    <button 
      *ngFor="let filter of ['ALL', 'HOT', 'WARM', 'COLD', 'UNANALYZED']"
      class="filter-btn"
      [class.active]="selectedFilter === filter"
      [disabled]="analyzing"
      (click)="applyFilter(filter)"
    >
      {{ filter === 'ALL' ? 'Semua' : filter === 'UNANALYZED' ? 'Belum Dianalisa' : filter }}
    </button>
  </div>

  <!-- Loading State (Initial Load) -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Memuat data...</p>
  </div>

  <!-- Leads Table -->
  <div *ngIf="!loading" class="leads-table-container">
    <table class="leads-table">
      <thead>
        <tr>
          <th>Klien</th>
          <th>Perusahaan</th>
          <th>Layanan</th>
          <th>Prioritas</th>
          <th>Status</th>
          <th>Tanggal</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let lead of filteredLeads">
          <td>
            <div class="client-info">
              <strong>{{ lead.namaKlien }}</strong>
              <small>{{ lead.emailKlien }}</small>
            </div>
          </td>
          <td>{{ lead.perusahaan || '-' }}</td>
          <td>{{ lead.layanan }}</td>
          <td>
            <span 
              class="priority-badge"
              [ngClass]="getPriorityClass(lead.skorPrioritas)"
            >
              {{ lead.skorPrioritas || 'N/A' }}
            </span>
          </td>
          <td>
            <span 
              class="status-badge"
              [class.analyzed]="lead.aiAnalyzed"
              [class.pending]="!lead.aiAnalyzed"
            >
              {{ lead.aiAnalyzed ? 'Analyzed' : 'Pending' }}
            </span>
          </td>
          <td>{{ formatDate(lead.tglRequest) }}</td>
          <td>
            <div class="action-buttons">
              <button 
                class="btn-icon" 
                (click)="showDetail(lead)"
                [disabled]="analyzing"
              >
                Detail
              </button>
              <!-- Button Analisis only appear when its unanalysed -->
              <button 
                *ngIf="!lead.aiAnalyzed"
                class="btn-icon btn-analyze"
                (click)="analyzeLead(lead.idRequest)"
                [disabled]="analyzing || isAnalyzing(lead.idRequest)"
              >
                <span *ngIf="!isAnalyzing(lead.idRequest)">Analisis</span>
                <span *ngIf="isAnalyzing(lead.idRequest)">Menganalisa...</span>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="filteredLeads.length === 0">
          <td colspan="7" class="empty-state">
            <div class="empty-illustration"></div>
            <p>Tidak ada lead yang sesuai filter</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="selectedLead">
    <div class="modal-header">
      <h2>Detail Lead Analysis</h2>
      <button class="close-btn" (click)="closeModal()">âœ•</button>
    </div>

    <div class="modal-body">
      <!-- Client Info -->
      <div class="detail-section">
        <h3>Informasi Klien</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Nama:</label>
            <span>{{ selectedLead.namaKlien }}</span>
          </div>
          <div class="detail-item">
            <label>Email:</label>
            <span>{{ selectedLead.emailKlien }}</span>
          </div>
          <div class="detail-item">
            <label>Perusahaan:</label>
            <span>{{ selectedLead.perusahaan || '-' }}</span>
          </div>
          <div class="detail-item">
            <label>Layanan:</label>
            <span>{{ selectedLead.layanan }}</span>
          </div>
        </div>
      </div>

      <!-- AI Analysis -->
      <div class="detail-section" *ngIf="selectedLead.aiAnalyzed">
        <h3>Hasil Analisa AI</h3>
        <div class="analysis-result">
          <div class="priority-display" [ngClass]="getPriorityClass(selectedLead.skorPrioritas)">
            <div>
              <strong>{{ selectedLead.skorPrioritas }}</strong>
            </div>
          </div>

          <div class="reason-box">
            <h4>Alasan scoring :</h4>
            <p>{{ selectedLead.alasanSkor }}</p>
          </div>

          <div class="analysis-meta">
            <small>Dianalisa pada: {{ formatDate(selectedLead.tglAnalisaAi) }}</small>
          </div>
        </div>
      </div>

      <!-- Not Analyzed Section -->
      <div class="detail-section" *ngIf="!selectedLead.aiAnalyzed">
        <div class="not-analyzed">
          <p>Lead ini belum dianalisa oleh AI</p>
          <button 
            class="btn-primary" 
            (click)="analyzeLead(selectedLead.idRequest); closeModal()"
            [disabled]="analyzing || isAnalyzing(selectedLead.idRequest)"
          >
            <span *ngIf="!isAnalyzing(selectedLead.idRequest)">Analisa sekarang</span>
            <span *ngIf="isAnalyzing(selectedLead.idRequest)">menganalisa...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>